# SpotlightChat → RAG 채팅 전환

**날짜**: 2026-02-10
**범위**: v1.2.0 - SpotlightChat을 시맨틱 검색에서 RAG 채팅으로 전환

## 변경된 파일

### 백엔드 (Rust)
- `src-tauri/src/models/snippet.rs` — `SnippetSource`, `AiChatResponse` 구조체 추가
- `src-tauri/src/commands/ai.rs` — `ai_chat` 반환 타입을 `String` → `AiChatResponse`로 구조화

### 프론트엔드
- `src/lib/types.ts` — `SnippetSource`, `AiChatResponse`, `SnippetContext` 타입 추가
- `src/lib/tauri.ts` — `aiApi.chat()` 함수 복원
- `src/hooks/useAI.ts` — `useAIChat()` 훅 추가
- `src/components/ai/MarkdownRenderer.tsx` — **신규** react-markdown + syntax highlighting
- `src/components/ai/SourceCards.tsx` — **신규** 출처 스니펫 pill 카드
- `src/components/ai/SpotlightChat.tsx` — **재작성** 채팅 UI
- `src/pages/HomePage.tsx` — `spotlightQuery` → `spotlightContext`, `onAskAI` prop 전달
- `src/components/snippet/SnippetDetail.tsx` — `onFindRelated` → `onAskAI`, Sparkles 아이콘

### 테스트
- `src/components/ai/SpotlightChat.test.tsx` — **재작성** (9 tests)
- `src/components/ai/MarkdownRenderer.test.tsx` — **신규** (8 tests)

### 패키지
- `react-markdown` 10.1.0 + `remark-gfm` 4.0.1 추가

## 테스트 결과
- Rust: 55 passed
- Frontend: 94 passed (기존 77 → 94, +17 new/rewritten)
- **Total: 149 tests**

## 구현 설명

### 왜 이렇게 구성했는가?
- 기존 `ai_chat` 백엔드가 이미 RAG 로직 전체를 구현하고 있었음 (임베딩 → 검색 → LLM 프롬프트)
- 프론트엔드만 서치바 복제에서 실제 채팅 UI로 전환하면 차별화 달성
- `AiChatResponse` 구조화로 LLM 답변 + 출처를 분리해 UI에서 활용 가능
- react-markdown + remark-gfm으로 마크다운 렌더링 (코드 블록 syntax highlight 포함)

### 장점
- 서치바 = "스니펫 찾기", RAG 채팅 = "지식 기반 질문 답변"으로 명확한 역할 분리
- LLM 답변의 코드 블록이 syntax highlighting으로 가독성 향상
- 출처 스니펫 카드 클릭으로 원본 스니펫 바로 이동 가능
- 세션 내 메시지 히스토리 유지, 다이얼로그 닫으면 리셋

### 단점 / 트레이드오프
- 아직 멀티턴 컨텍스트 없음 (각 메시지가 독립적인 RAG 호출)
- LLM 응답 시간이 길 수 있음 (5초 이후 경과 시간 표시로 완화)
- react-markdown 패키지 추가로 번들 사이즈 증가

### 아키텍처 결정
- `SnippetSource` 별도 구조체: 프론트에서 score 표시 + snippet 링크에 필요한 최소 정보만
- `score >= 0.3` 필터: 낮은 관련도 소스는 노이즈이므로 제외
- MarkdownRenderer: CodeBlock 컴포넌트 재사용 대신 간소화 버전 사용 (헤더바 등 불필요)
